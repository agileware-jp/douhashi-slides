name: inverse
layout: true
class: underscore

---
class: center, middle, hero

# 乱立してるRedmineを一つにまとめる話

@douhashi

---
# 自己紹介

---
# アンケート

## 社内にRedmineは複数ある or ない?

---
class: center, middle
# ある日、こんな依頼が...

---
class: center, middle
## 複数あるRedmineを統合したい

---
# 統合したい理由

1. 現在 **20台** 以上のRedmineが乱立していて運用もバラバラ
2. すべてのインスタンスが1台のサーバに同居しているのでパフォーマンスの問題もでているので解消したい

---
class: center, middle

## わかった。じゃあ統合しよう。
### (結構カジュアルに決断)

---
class: center, middle

# ここから苦労話スタート。

---
# Redmine側の課題 1

## Redmineって...

### **チケット番号 = DBのID**なんだよね...

---
# チケット番号 = ID問題

1. DB上のauto incrementなid列をチケット番号に使用している
2. コミットコメントやチケット等で「#100」などチケット番号で参照している

=> **つまり、単純にCSV出力/インポートでは参照が崩れる!**

---
# Redmine側の課題 2

### 単純に統合しちゃうと、トラッカーとかステータス大爆発しちゃうよね

### 出来る限りはまとめたい、よねー。

---
class: center, middle
# 解決策

---
class: center, middle
## 賢いRedmine統合ツール作った

(弊社の優秀なエンジニアが...!)

---
# こんな感じ

1. 統合元Redmineのデータを **中間データ(SQLite)** としてエクスポート
    * 統合前のIDを中間データに保存しておく(from ID)
2. 統合先へインポート
    * 統合後のIDを保存しておく(to ID)
3. from idを元に、チケット/Wiki/コミットコメント等の参照を張り替える

---
# こんなことも出来る

1. 統合元Redmineのトラッカーやカテゴリ、ステータス等を統合先の既存データに合わせる
    * 設定ファイルで定義できるようにした
2. 添付ファイルをごっそり移行する

---
class: center, middle
# 賢いツールができたので

## いざ、統合テスト!!

---
class: center, middle
# ここで問題発生

---
class: center, middle
# むっちゃ遅い!!!

---
# 最大級のRedmineだけで

1. チケット 約 **15,000** 件
2. 履歴 約 **200,000** 件
3. カスタムフィールドの入力値 約 **200,000** 件

このデータ量で3日かけてもインポートまで終わらない...

---
class: center, middle
# でも、業務は継続しないと

## = 休日しか統合作業できない

---
class: center, middle
## **ここからが本当の戦い**

---
# インフラ的アプローチ

1. サーバスペックの一時的増強
    * 通常運用時の倍ぐらいにあげて貰った

けど、IOが足を引っ張って1.3倍ぐらいの成果...

---
# ソフト的アプローチ

1. CPUの有効活用のため、プロセスを分割する
2. 時間のかかる履歴/コミットログ等のチケット参照の書き換え処理を分離、統合後に実行可能とした

---
class: center, middle
# ちなみに

---
class: center, middle
# テスト開始からここまでで2ヶ月ぐらいかかってます

(土日は客先での寝泊まりの日々)

---
class: center, middle

## 守衛さんも顔パスするレベル

「アジャイルさんね。今日も遅いの?」

---
class: center, middle
# 流石に客先で寝るのは辛いので...

---
# スマホに通知!

1. 都度都度push通知するようにした
    * im.kayac.com というRESTでケータイに通知送れるサービス
    * 便利なのでぜひ。

---
class: center, middle
# 涙ぐましい努力の結果

## 一番デカい子が **43時間** で、統合出来るようになりました。

---
class: center, middle
# 無事、最終的に移行対象となった16台のRedmineサーバが統合されました

---
# 統合後のRedmine

---
# 統合してみたメリット

1. 一元管理が出来る
2. 他のプロジェクトの様子が見える
3. 業務フローを統合していける

---
# 今後の運用課題

1. アクセス集中によるパフォーマンス劣化対応
2. 業務分析、ワークフローの統一化(大変そう)
3.

---
# やってみたいこと
